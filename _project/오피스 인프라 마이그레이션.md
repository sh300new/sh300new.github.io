---
title: 포티게이트 VPN 마이그레이션
date: 2023-10-29
---

# 포티게이트 VPN 마이그레이션

---

작성일: {{ page.date | date: '%Y-%m-%d' }}  

---

## 디자인

처음엔 현재 사용하는 포티게이트가 너무 불편해서 다른 솔루션 도입을 고민했습니다.  
특히 보안팀에서 **SSO 연동**을 원했지만, 기존 보안 정책(인터넷 차단 조건) 때문에  
**포티클라이언트 오류**가 많고 연동도 어려웠습니다.

하지만, **포티게이트의 높은 마켓쉐어(22%)**를 확인하고 그대로 진행하기로 결정했습니다.  
주요 개선점은 **AWS 기반으로 속도 향상**과 **OTP 앱 대신 SSO 로그인** 도입입니다.

---

## 구축 단계

**1. 인스턴스 생성 및 설정**  
   AMI를 통해 인스턴스를 만들고 admin 페이지에 접근해 설정하는 것은 간단했지만,  
   **정책 마이그레이션**이 큰 도전이었습니다.  
   
**2. 정책 마이그레이션**  
   - Fortigate에서 백업 파일로 전체 컨피그(10만 라인 이상)를 다운받아 확인했습니다.
   - 하지만 온프레미스와 AMI 구성이 달라, 기존 컨피그와 비교하여 **필요 설정만 선택적 마이그레이션**을 시도했습니다.
   - **웹 필터가 80%**를 차지하던 기존 컨피그에서 필요한 부분만 간소화하였습니다.

**3. HA 설정 문제 해결**  
   - **HA 인터페이스 비활성화** 문제로 원격 연결이 차단되는 상황이 발생했습니다.
   - Fortigate AMI는 **인스턴스 ID 기반 SSH 비밀번호**를 사용해 AWS 콘솔에서 접근이 가능했습니다.
   - HA 포트를 별도 서브넷으로 분리하여 헬스 체크 빈도에 따른 네트워크 방해 문제를 해결했습니다.

---

## 운영 단계

운영 중 이슈는 **웹 필터**에서 주로 발생했습니다.  
다양한 CDN 서비스와 **MS 관련 URL 60여 개 추가**가 필요했습니다.

1. **MS URL 자동 추가**  
   - 장비 백업 컨피그와 MS URL JSON 파일을 ChatGPT로 변환 후, 웹 필터에 추가하여 간편히 해결했습니다.

2. **포티 클라이언트 SSO 연결 오류**  
   - SSO 연결 후 8시간 후 재연결이 불가하며, **재부팅만으로 해결** 가능했습니다.
   - 내부 MFA를 사용하는 **포티토큰**에서는 문제가 없지만 외부 인증은 오류가 잦습니다.

---

## 결론

FortiClient AMI 비용은 **하루 약 50달러**로, 2중화 시 한 달 3000달러에 이릅니다.  
기존 환경과 보안팀 요구가 아니었다면 **OpenVPN을 추천**합니다.  
OpenVPN은 저렴하며, SSO 인증 오류가 거의 없습니다.

**대안 구성 방안**  
- 방화벽과 웹 필터가 필요하지 않다면 **OpenVPN**과 **AWS SG**로 접근 제어 추천
- 웹 필터는 필요 시 **사용자 네트워크에 Squid 설치**로 인스턴스 비용 절감 가능