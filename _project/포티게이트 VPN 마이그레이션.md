---
title: 포티게이트 VPN 마이그레이션
date: 2024-10-29 # 최초 작성일 수동 입력
last_modified_at: 2024-10-30 # GitHub Actions로 자동 업데이트
---

# 포티게이트 VPN 마이그레이션

---

작성일: {{ page.date | date: '%Y-%m-%d' }}  
마지막 수정: {{ page.last_modified_at | date: '%Y-%m-%d' }}

---

## 디자인

처음엔 현재 사용하는 포티게이트가 너무 불편해서 다른 솔루션을 도입하는 것도 생각했다.  
특히 보안팀에서는 SSO 연동을 원했는데, 이게 기존 보안정책(VPN 연결이 안돼있으면 인터넷이 안되는) 때문에  
연동이 너무 힘들고 포티클라이언트도 오류가 많아 다른 솔루션을 탐색해보려고 했으나  
포티게이트의 마켓쉐어가 무려 22%라는 것을 확인하고는 그냥 진행하기로 했다.

주요 개선점은 **AWS 상에 올라가 속도가 크게 개선**되는 점과  
기존에 별도의 OTP 앱을 써야 했던 로그인 방법을 **SSO로 바꾸는 것**이었다.

---

## 구축 단계

**1. 인스턴스 생성 및 설정**  
   - AMI를 통해 인스턴스를 만들고 admin 페이지에 접근하여 간단한 설정을 넣는 것은 어려움이 없었으나  
     문제는 정책을 마이그레이션 하는 것이었다.
   - 자동으로 할 방법을 찾아보니 포티게이트는 백업 파일을 다운 받을 수 있었으나,  
     이건 장비의 전체 컨피그를 다운받는 것으로 무려 10만 라인이 넘었고  
     같은 버전이었지만 온프레미스용과 AMI는 구성이 상당히 달랐다.

**2. 컨피그 마이그레이션**  
   - 결국 컨피그는 일정한 규칙을 가진다는 점에 착안하여 신규 장비의 컨피그를 추출하고,  
     기존 컨피그와 이름만 추출해서 비교하여 마이그레이션이 꼭 필요한 설정만을 찾아보기로 했다.
   - 약 80개의 컨피그가 비교가 필요했고, 기존 컨피그의 80%가 웹필터였으므로  
     필요한 부분만 옮길 수 있었다.

**3. HA 설정 문제 해결**  
   - 포티게이트는 특이하게 HA 인터페이스가 일반 인터페이스로 인식되지 않는다.  
   - AMI는 하나의 인터페이스만 연결되어 있는데 이를 HA 인터페이스로 지정하면 원격 연결이 끊긴다.
   - 다행히 FortiGate AMI는 **고정된 SSH 비밀번호로 콘솔 연결**을 통해 접근할 수 있어 설정을 초기화하고  
     추가 인터페이스를 생성하여 장비에 연결한 후 HA 포트로 지정하였다.
   - HA가 헬스 체크를 자주 하다 보니 같은 서브넷을 사용하면 네트워크가 방해받아,  
     별도의 서브넷을 생성하고 HA 포트를 각각 연결하여 문제를 해결했다.

---

## 운영 단계

1. **웹필터 URL 추가**  
   - 어떤 서비스에 문제가 있으면 거의 cdn url 중하나가 웹필터에 의해 차단된 것이었다.
     최근에 MS 관련 60여 개의 URL이 추가되었는데,  
     장비 백업 컨피그를 받아 MS URL JSON 파일을 ChatGPT로 변환하여  
     웹필터 형식으로 만든 후 백업 컨피그에 추가하여 간단히 해결했다.


2. **포티클라이언트 SSO 연결 문제**  
   - 포티클라이언트가 지정된 시간(기본 8시간)이 지난 후 재연결 시 연결되지 않으며 재부팅해야만 연결이 된다.
   - 포티토큰을 이용한 내부 MFA는 문제가 없지만 외부 인증은 오류가 발생한다.  
   - 클라이언트 버전을 올리고 낮추어도 해결되지 않았다.
   - 드디어 방법을 찾았다, 역으로 생각해서 네트워크를 재부팅 한것과 같이 초기화하면 되겠다는 생각을 했다.


3. **SSO 인증 상태로 개인별 고정 IP 부여하기 **
   - 보안팀의 요구사항으로 개인별 고정 ip를 부여해야 했다.
   - 기존 포티게이트 사용 방식으로는 간단히 부여할 수 있지만 SSO 인증 상태로는 어려움이 있었는데, 포티게이트는 SSO 인증으로 사용자를 만들면 기본적으로 '그룹'단위로 식별하기 때문이다. 그래서 애초에 SSO 인증으로 만들 수 있는 사용자 객체는 그룹밖에 없다.
   - SSO 인증은 상호간에 클레임이라는 방식으로 유저의 데이터를 주고받는다. 그래서 이 부분을 중점적으로 살펴봤다.
   - 클레임을 통해 그룹이 아닌 user의 계정을 추가해줬고, 이걸 통해 포티게이트가 인식하도록 했다.
   - 그 후, 개인마다 사용자 그룹을 만들어줬고, SSl-VPN 포털도 개인마다 만든 후 VPN 설정에 IP를 한개씩 부여하여 개인별로 고정 IP를 가질 수 있게 구성했다.

```bash
sudo networksetup -setnetworkserviceenabled Wi-Fi off
sudo pkill -f forti
sudo networksetup -setnetworkserviceenalbed Wi-Fi on
```
---

## 결론

포티게이트 AMI의 하루 사용료는 약 50달러, 2중화 시 100달러로 한 달 약 3000달러에 이른다.  
기존 환경이나 보안팀 요구가 아니라면 OpenVPN이 더 적합했을 것이다.

- **대안 제안**: VPN이 필요하다면 OpenVPN을 사용하고 대부분의 리소스가 AWS 상에 있으므로  
  SG를 활용하여 접근을 제어하는 것이 더 경제적일 수 있다.
- **웹필터**는 사용자 네트워크에 **Squid를 설치**하여 제어하면 인스턴스 비용을 제외하고 무료로 활용 가능하다.

---

