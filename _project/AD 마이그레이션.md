---
title: AD 마이그레이션
date: 2023-10-29 # 최초 작성일 수동 입력
---

# AD 마이그레이션

---

작성일: {{ page.date | date: '%Y-%m-%d' }}

---

## 디자인

기존 AD 구성은 DNS를 제외하고는 이중화되어 있지 않았다.  
또한, ADFS 서비스를 위해 인터넷 구간에 설치해놓은 WAP(Web Application Proxy)가  
네트워크 구성을 복잡하게 만들어 포티게이트 SSO 인증 시 오류가 자주 발생했다.  
기존 ADFS는 WAP를 사용하기 때문에 헤더를 통한 트래픽 분리 정책 적용(Mobile 환경인지 PC 환경인지)이 어려웠는데,  
AWS WAF를 통해 이를 해결하려고 했다.

---

## 구축 단계

**1. AD 종류 선택**  
처음엔 관리가 용이한 Managed AD를 사용하려고 했다. 그러나 Managed AD는  
구축이 필요한 ADFS 서비스를 제공하지 않기 때문에 별도의 Windows 서버를 구축해야 했고,  
관리자는 AD Admin 권한이 없어 기존 AD에 조인할 수 없었다.  
결국 Windows 서버 두 대를 구축한 후, 여기에 ADDC 기능을 추가하기로 했다.

**2. AD DC 구축**  
AD DC로 설정하기 위해서는 도메인에 조인된 후 서브 DC 역할을 부여받아야 하는데,  
요즘에는 서브 도메인 컨트롤러가 아닌 **FSMO 기능을 가지지 않은 DC 컨트롤러**라고 부른다.
  - AD 관련 다양한 기능을 수행하는 서버를 뜻하며, 보통 한 서버에 몰려 있다. 궁금하면 ChatGPT에 물어보자. 

도메인 컨트롤러 기능을 설치한 후 DC 설정이 필요하다. 이때 기존 DC의 도메인을 입력하면 된다.  
여기서 자주 발생하는 오류가 바로 **“RPC 서버를 찾을 수 없습니다”**와 **"이 계정은 충분한 권한을 가지고 있지 않습니다"**인데,  
결국 **SMB(445)**와 **RPC(135)** 통신 문제다.  
이번 프로젝트를 통해 가장 크게 느낀 것은 **Windows 서버끼리는 무조건 이 두 포트가 열려 있어야 한다**는 점이다.

특히 **SMB 포트 문제**는 트러블슈팅이 어렵다. Windows는 특정 역할 수행 시 서비스 계정을 사용하며,  
예를 들어 서브 DC도 서비스 계정을 가지고 있는데, 이 SMB 포트가 막혀 있으면  
서브 DC가 메인 DC에 변경 사항을 전달할 수 없어 동기화에 실패하고 권한 부족 오류가 발생한다.  
따라서 Windows 시스템을 구축한다면 서버 간에 이 두 포트를 열어놓는 것이 정신건강에 좋다.

**3. ADFS 구축**  
ADFS는 AD가 제공하는 인증 위임 서비스로, MS, Slack 같은 외부 서비스에 로그인할 때  
한 번 더 웹페이지를 통해 계정 정보를 입력하게 하여 보안을 강화하는 기능이다.  
윈도우 서버 라이선스에 포함되어 있어 추가 비용 없이 사용할 수 있는 Windows 서버의 기능이다.

AD 마이그레이션 중 가장 어려웠던 부분이었는데, 처음엔 기존 ADFS 서버 팜에 조인하여 이중화를 시도하고  
ALB를 연결했으나, **ALB를 통해 연결할 때 502 오류**가 계속 발생했다.  
문제의 원인은 ALB가 ADFS에 IP로 요청을 보내 인증서 오류가 발생한 것인데,  
**netsh 명령어로 IP와 인증서를 바인딩**해서 해결해야 했지만 여전히 502 오류가 발생해  
결국 새로운 ADFS 서버 팜을 구축하기로 했다.

그 후 ADFS 메인 서버 변경 과정에서 Azure Connect 설정 변경이 필요했는데,  
이 과정이 복잡하고 마땅한 가이드도 없었으며, MS 지원에서도 애매한 답변만 제공되어  
다시 기존 AD에 조인하는 방법을 고려하게 되었다.

그러던 중 중요한 문제를 발견했는데, 이전 시도에서 ADFS가 서비스 중인 도메인이 아닌  
다른 도메인으로 테스트 요청을 보냈던 점이었다. 이는 기존 ADFS 도메인에 HTTPS 요청을 보낼 수 없어  
다른 도메인에 ALB의 CNAME을 만들어 신규 ADFS에 요청을 보냈던 점인데, 잘못된 접근이었다는 것을 깨달았다.  
사전 공지 후 기존 ADFS 도메인의 DNS를 신규 ADFS 서버로 옮겨 인증을 시도하자 정상적으로 작동했다.  
**ADFS 메인 변경은 매우 간단**했으며, 다음 명령어로 설정할 수 있었다.

- **신규 서버**: `Set-AdfsSyncProperties -Role PrimaryComputer`
- **기존 서버**: `Set-AdfsSyncProperties -Role SecondaryComputer`

---

## 운영 단계

1. **AD 메인 서버 오류 메시지 발견**  
   AD DC를 동기화한 후 서브 DC에서 생성한 계정이 메인 DC로 동기화되는 것을 확인했음에도,  
   AD 정기 점검에서 메인 DC에 지속적인 오류 메시지가 발생했다.  
   이는 서브 -> 메인으로는 135, 445 포트가 열려 있어 동기화가 이루어졌지만,  
   메인 -> 서브로는 135, 445 포트가 열려 있지 않아 메인 DC가 서브 DC를 인식하지 못한 것이 원인이었다.

---

## 결론

Windows 서버는 사용료가 비싸지만, 설치되는 모든 추가 기능에 대해 추가 비용이 발생하지 않으며,  
LDAP과 RADIUS 인증을 통해 생각보다 편리하게 사용할 수 있다.  
다만, Windows 서버를 사용할 경우 NACL로 트래픽을 제어하기는 어렵다.  
서로 관련 없어 보이는 Windows 서버들도 특정 기능에서 135, 445 포트를 사용해 서로 통신하기 때문이다.

---
