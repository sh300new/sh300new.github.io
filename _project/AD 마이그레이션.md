---
title: AD 마이그레이션
date: 2023-10-29 # 최초 작성일 수동 입력
---

# AD 마이그레이션

---

작성일: {{ page.date | date: '%Y-%m-%d' }}  

---

## 디자인

기존 AD 구성은 dns를 제외하고는 이중화 되어있지 않았다.
또한 ADFS 서비스를 위해 인터넷 구간에 설치해놓은 WAP(web application proxy)가
네트워크 구성을 복잡하게 만들어 포티게이트 SSO 인증시 오류가 자주 발생했다.


---

## 구축 단계

**1. 인스턴스 생성 및 설정**  
   - AMI를 통해 인스턴스를 만들고 admin 페이지에 접근하여 간단한 설정을 넣는 것은 어려움이 없었으나  
     문제는 정책을 마이그레이션 하는 것이었다.
   - 자동으로 할 방법을 찾아보니 포티게이트는 백업 파일을 다운 받을 수 있었으나,  
     이건 장비의 전체 컨피그를 다운받는 것으로 무려 10만 라인이 넘었고  
     같은 버전이었지만 온프레미스용과 AMI는 구성이 상당히 달랐다.

**2. 컨피그 마이그레이션**  
   - 결국 컨피그는 일정한 규칙을 가진다는 점에 착안하여 신규 장비의 컨피그를 추출하고,  
     기존 컨피그와 이름만 추출해서 비교하여 마이그레이션이 꼭 필요한 설정만을 찾아보기로 했다.
   - 약 80개의 컨피그가 비교가 필요했고, 기존 컨피그의 80%가 웹필터였으므로  
     필요한 부분만 옮길 수 있었다.

**3. HA 설정 문제 해결**  
   - 포티게이트는 특이하게 HA 인터페이스가 일반 인터페이스로 인식되지 않는다.  
   - AMI는 하나의 인터페이스만 연결되어 있는데 이를 HA 인터페이스로 지정하면 원격 연결이 끊긴다.
   - 다행히 FortiGate AMI는 **고정된 SSH 비밀번호로 콘솔 연결**을 통해 접근할 수 있어 설정을 초기화하고  
     추가 인터페이스를 생성하여 장비에 연결한 후 HA 포트로 지정하였다.
   - HA가 헬스 체크를 자주 하다 보니 같은 서브넷을 사용하면 네트워크가 방해받아,  
     별도의 서브넷을 생성하고 HA 포트를 각각 연결하여 문제를 해결했다.

---

## 운영 단계

운영 단계에서 이슈는 주로 **웹필터**에서 발생했다.  
다양한 CDN 서비스로 인해 여러 URL을 추가하지 않으면 웹 서비스를 이용하기 어려웠다.

1. **MS 관련 URL 추가**  
   - 최근에 MS 관련 60여 개의 URL이 추가되었는데,  
     장비 백업 컨피그를 받아 MS URL JSON 파일을 ChatGPT로 변환하여  
     웹필터 형식으로 만든 후 백업 컨피그에 추가하여 간단히 해결했다.

2. **포티클라이언트 SSO 연결 문제**  
   - 포티클라이언트가 지정된 시간(기본 8시간)이 지난 후 재연결 시 연결되지 않으며  
     재부팅해야만 연결이 된다.
   - 포티토큰을 이용한 내부 MFA는 문제가 없지만 외부 인증은 오류가 발생한다.  
   - 클라이언트 버전을 올리고 낮추어도 해결되지 않았다.

---

## 결론

FortiClient AMI의 하루 사용료는 약 50달러, 2중화 시 100달러로 한 달 약 3000달러에 이른다.  
기존 환경이나 보안팀 요구가 아니라면 OpenVPN이 더 적합했을 것이다.

- **대안 제안**: VPN이 필요하다면 OpenVPN을 사용하고 대부분의 리소스가 AWS 상에 있으므로  
  SG를 활용하여 접근을 제어하는 것이 더 경제적일 수 있다.
- **웹필터**는 사용자 네트워크에 **Squid를 설치**하여 제어하면 인스턴스 비용을 제외하고 무료로 활용 가능하다.

---

